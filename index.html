<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Cluedo - Hub</title>
  <link rel="stylesheet" href="./css/style.css"/>
  <link rel="icon" href="./favicon.ico" type="image/x-icon"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
</head>
<body>
  <div class="container">
    <h1>Hub Cluedo</h1>
    <div class="card hub-card">
      <section class="hub-section">
        <h2>Acc√®s principal</h2>
        <div class="hub-grid">
          <a class="hub-button hub-button-qr" href="./team.html">üë• Page √©quipe</a>
          <a class="hub-button" href="./admin.html">üîê Administration</a>
          <a class="hub-button" href="./monitor.html">üìä Supervision</a>
        </div>
      </section>

      <section class="hub-section">
        <h2>Acc√®s personnages (1 √† 15)</h2>
        <div class="hub-bulk-actions hub-desktop-only">
          <button id="hub-download-zip-qr" type="button" class="hub-button hub-button-qr">T√©l√©charger tous les QR codes (ZIP)</button>
          <button id="hub-download-pdf-qr" type="button" class="hub-button hub-button-secondary">T√©l√©charger en PDF (A4 ‚Äì 6 QR codes par page)</button>
        </div>
        <div class="hub-quick-access">
          <h3>Acc√®s rapide</h3>
          <div id="hub-quick-access-list" class="hub-quick-access-list">Chargement‚Ä¶</div>
        </div>
        <div id="hub-character-list" class="hub-character-list">Chargement‚Ä¶</div>
      </section>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const container = document.getElementById("hub-character-list");
      const quickAccessContainer = document.getElementById("hub-quick-access-list");
      const downloadZipButton = document.getElementById("hub-download-zip-qr");
      const downloadPdfButton = document.getElementById("hub-download-pdf-qr");
      const fallbackName = (id) => `Personnage ${id}`;
      const characterEntries = [];

      const sanitizeForFilename = (value) => value
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-zA-Z0-9_-]+/g, "_")
        .replace(/^_+|_+$/g, "") || "Personnage";

      const setButtonBusy = (button, busyLabel, callback) => {
        const originalLabel = button.textContent;
        button.disabled = true;
        button.textContent = busyLabel;

        return callback()
          .catch((error) => {
            console.error(error);
            alert("Une erreur est survenue pendant la g√©n√©ration des QR codes.");
          })
          .finally(() => {
            button.disabled = false;
            button.textContent = originalLabel;
          });
      };

      const triggerDownload = (blob, filename) => {
        const blobUrl = URL.createObjectURL(blob);
        const downloadLink = document.createElement("a");
        downloadLink.href = blobUrl;
        downloadLink.download = filename;
        downloadLink.rel = "noopener";
        document.body.appendChild(downloadLink);
        downloadLink.click();
        downloadLink.remove();
        URL.revokeObjectURL(blobUrl);
      };

      const buildQrCanvas = async (id, name) => {
        const playUrl = new URL(`./play.html?id=${id}`, window.location.href).href;
        const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=1024x1024&data=${encodeURIComponent(playUrl)}`;
        const qrResponse = await fetch(qrApiUrl);
        if (!qrResponse.ok) {
          throw new Error(`Impossible de g√©n√©rer le QR code pour le personnage ${id}`);
        }
        const qrBlob = await qrResponse.blob();

        const imageBitmap = await createImageBitmap(qrBlob);
        const canvas = document.createElement("canvas");
        canvas.width = 1024;
        canvas.height = 1160;
        const context = canvas.getContext("2d");

        context.fillStyle = "#ffffff";
        context.fillRect(0, 0, canvas.width, canvas.height);
        context.drawImage(imageBitmap, 0, 0, 1024, 1024);

        context.fillStyle = "#111111";
        context.font = "bold 48px Arial, sans-serif";
        context.textAlign = "center";
        context.textBaseline = "middle";
        context.fillText(`${id} - ${name}`, canvas.width / 2, 1092);

        return canvas;
      };

      const buildQrImage = async (id, name) => {
        const canvas = await buildQrCanvas(id, name);

        return new Promise((resolve) => {
          canvas.toBlob((blob) => resolve(blob), "image/png");
        });
      };

      const downloadQr = async (id, name) => {
        const fileSafeName = sanitizeForFilename(name);
        const blob = await buildQrImage(id, name);
        triggerDownload(blob, `qr_${id}_${fileSafeName}.png`);
      };

      let personnages = {};
      try {
        const response = await fetch(`./data/personnages.json?ts=${Date.now()}`);
        if (response.ok) {
          personnages = await response.json();
        }
      } catch (error) {
        // Fallback below intentionally keeps Hub usable if JSON is temporarily unavailable.
      }

      const fragment = document.createDocumentFragment();
      const quickAccessFragment = document.createDocumentFragment();

      for (let id = 1; id <= 15; id += 1) {
        const rawName = personnages[String(id)]?.nom;
        const name = rawName && rawName.trim() ? rawName.trim() : fallbackName(id);
        characterEntries.push({ id, name });

        const card = document.createElement("article");
        card.className = "hub-character-card";
        card.id = `hub-character-${id}`;

        const quickAccessButton = document.createElement("a");
        quickAccessButton.className = "hub-quick-access-button";
        quickAccessButton.href = `#hub-character-${id}`;
        quickAccessButton.textContent = `${id} - ${name}`;
        quickAccessButton.rel = "noopener";
        quickAccessFragment.appendChild(quickAccessButton);

        const title = document.createElement("h3");
        title.className = "hub-character-title";
        title.textContent = `${id} - ${name}`;

        const actions = document.createElement("div");
        actions.className = "hub-character-actions";

        const playLink = document.createElement("a");
        playLink.className = "hub-button";
        playLink.href = `./play.html?id=${id}`;
        playLink.textContent = `Jouer ‚Äì ${id} - ${name}`;

        const characterLink = document.createElement("a");
        characterLink.className = "hub-button hub-button-secondary";
        characterLink.href = `./character.html?id=${id}`;
        characterLink.textContent = `Personnage ‚Äì ${id} - ${name}`;

        const qrButton = document.createElement("button");
        qrButton.type = "button";
        qrButton.className = "hub-button hub-button-qr hub-desktop-only";
        qrButton.textContent = "T√©l√©charger le QR code";
        qrButton.addEventListener("click", async () => {
          await downloadQr(id, name);
        });

        actions.append(playLink, characterLink, qrButton);
        card.append(title, actions);
        fragment.appendChild(card);
      }

      container.innerHTML = "";
      container.appendChild(fragment);
      quickAccessContainer.innerHTML = "";
      quickAccessContainer.appendChild(quickAccessFragment);

      downloadZipButton.addEventListener("click", () => setButtonBusy(downloadZipButton, "Pr√©paration du ZIP‚Ä¶", async () => {
        if (!window.JSZip) {
          throw new Error("La librairie JSZip n'est pas disponible.");
        }

        const zip = new window.JSZip();
        for (const entry of characterEntries) {
          const blob = await buildQrImage(entry.id, entry.name);
          const fileSafeName = sanitizeForFilename(entry.name);
          zip.file(`qr_${entry.id}_${fileSafeName}.png`, blob);
        }

        const zipBlob = await zip.generateAsync({ type: "blob" });
        triggerDownload(zipBlob, "cluedo_qr_codes.zip");
      }));

      downloadPdfButton.addEventListener("click", () => setButtonBusy(downloadPdfButton, "Pr√©paration du PDF‚Ä¶", async () => {
        if (!window.jspdf || !window.jspdf.jsPDF) {
          throw new Error("La librairie jsPDF n'est pas disponible.");
        }

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ unit: "mm", format: "a4", orientation: "portrait" });
        const pageWidth = 210;
        const pageHeight = 297;
        const margin = 12;
        const gap = 8;
        const columns = 2;
        const rows = 3;
        const pageSlots = columns * rows;
        const cellWidth = (pageWidth - (margin * 2) - gap) / columns;
        const cellHeight = (pageHeight - (margin * 2) - (gap * (rows - 1))) / rows;

        for (let index = 0; index < characterEntries.length; index += 1) {
          if (index > 0 && index % pageSlots === 0) {
            pdf.addPage();
          }

          const entry = characterEntries[index];
          const slot = index % pageSlots;
          const col = slot % columns;
          const row = Math.floor(slot / columns);
          const x = margin + col * (cellWidth + gap);
          const y = margin + row * (cellHeight + gap);
          const canvas = await buildQrCanvas(entry.id, entry.name);
          const dataUrl = canvas.toDataURL("image/png");

          pdf.setDrawColor(200);
          pdf.rect(x, y, cellWidth, cellHeight);
          pdf.setFont("helvetica", "bold");
          pdf.setFontSize(10);
          pdf.text(`${entry.id} - ${entry.name}`, x + (cellWidth / 2), y + 7, { align: "center" });

          const qrSize = Math.min(cellWidth - 12, cellHeight - 25);
          const qrX = x + (cellWidth - qrSize) / 2;
          const qrY = y + 10;
          pdf.addImage(dataUrl, "PNG", qrX, qrY, qrSize, qrSize);

          pdf.setFont("helvetica", "normal");
          pdf.setFontSize(9);
          pdf.text(`play.html?id=${entry.id}`, x + (cellWidth / 2), y + cellHeight - 5, { align: "center" });
        }

        const pdfBlob = pdf.output("blob");
        triggerDownload(pdfBlob, "cluedo_qr_codes_a4.pdf");
      }));
    });
  </script>
</body>
</html>
