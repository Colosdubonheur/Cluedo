<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Cluedo - Hub</title>
  <link rel="stylesheet" href="./css/style.css"/>
  <link rel="icon" href="./favicon.ico" type="image/x-icon"/>
</head>
<body>
  <div class="container">
    <h1>Hub Cluedo</h1>
    <div class="card hub-card">
      <section class="hub-section">
        <h2>Acc√®s principal</h2>
        <div class="hub-grid">
          <a class="hub-button" href="./admin.html">üîê Administration</a>
          <a class="hub-button" href="./monitor.html">üìä Supervision</a>
        </div>
      </section>

      <section class="hub-section">
        <h2>Acc√®s personnages (1 √† 15)</h2>
        <div id="hub-character-list" class="hub-character-list">Chargement‚Ä¶</div>
      </section>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const container = document.getElementById("hub-character-list");
      const fallbackName = (id) => `Personnage ${id}`;

      let personnages = {};
      try {
        const response = await fetch(`./data/personnages.json?ts=${Date.now()}`);
        if (response.ok) {
          personnages = await response.json();
        }
      } catch (error) {
        // Fallback below intentionally keeps Hub usable if JSON is temporarily unavailable.
      }

      const fragment = document.createDocumentFragment();

      for (let id = 1; id <= 15; id += 1) {
        const rawName = personnages[String(id)]?.nom;
        const name = rawName && rawName.trim() ? rawName.trim() : fallbackName(id);

        const card = document.createElement("article");
        card.className = "hub-character-card";

        const title = document.createElement("h3");
        title.className = "hub-character-title";
        title.textContent = `${id} - ${name}`;

        const actions = document.createElement("div");
        actions.className = "hub-character-actions";

        const playLink = document.createElement("a");
        playLink.className = "hub-button";
        playLink.href = `./play.html?id=${id}`;
        playLink.textContent = `Jouer ‚Äì ${id} - ${name}`;

        const characterLink = document.createElement("a");
        characterLink.className = "hub-button hub-button-secondary";
        characterLink.href = `./character.html?id=${id}`;
        characterLink.textContent = `Personnage ‚Äì ${id} - ${name}`;

        const qrButton = document.createElement("button");
        qrButton.type = "button";
        qrButton.className = "hub-button hub-button-qr hub-desktop-only";
        qrButton.textContent = "T√©l√©charger le QR code";
        qrButton.addEventListener("click", () => {
          const playUrl = new URL(`./play.html?id=${id}`, window.location.href).href;
          const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=1024x1024&data=${encodeURIComponent(playUrl)}`;

          const downloadLink = document.createElement("a");
          downloadLink.href = qrApiUrl;
          downloadLink.download = `cluedo-play-id-${id}.png`;
          downloadLink.rel = "noopener";
          document.body.appendChild(downloadLink);
          downloadLink.click();
          downloadLink.remove();
        });

        actions.append(playLink, characterLink, qrButton);
        card.append(title, actions);
        fragment.appendChild(card);
      }

      container.innerHTML = "";
      container.appendChild(fragment);
    });
  </script>
</body>
</html>
