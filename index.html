<?php
require_once __DIR__ . '/includes/cache.php';
cluedo_send_html_no_cache_headers();
?>
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Cluedo - Hub</title>
  <link rel="stylesheet" href="<?= htmlspecialchars(cluedo_asset_url('./css/style.css'), ENT_QUOTES, "UTF-8") ?>"/>
  <link rel="icon" href="<?= htmlspecialchars(cluedo_asset_url('./favicon.ico'), ENT_QUOTES, "UTF-8") ?>" type="image/x-icon"/>
</head>
<body>
  <div class="hub-app-version" data-app-version aria-label="Version applicative"></div>
  <div class="container">
    <h1>Hub Cluedo</h1>
    <div class="card hub-card">
      <section class="hub-section">
        <h2>Acc√®s principal</h2>
        <div class="hub-grid">
          <a class="hub-button hub-button-secure" href="./admin.html">üîê Administration</a>
          <a class="hub-button hub-button-secure" href="./monitor.html">üìä Supervision</a>
          <a class="hub-button hub-button-free" href="./team.html?test=1">üë• Espace √©quipe</a>
          <button type="button" class="hub-button hub-button-secondary" id="hub-show-team-qr">üì± Afficher le QR code ‚Äì Espace √©quipe</button>
        </div>
      </section>

      <section class="hub-section">
        <h2>Acc√®s personnages actifs</h2>
        <div id="hub-character-list" class="hub-character-list">Chargement‚Ä¶</div>
      </section>
    </div>
  </div>

  <div class="hub-qr-modal is-hidden" id="hub-qr-modal" role="dialog" aria-modal="true" aria-labelledby="hub-qr-title">
    <div class="hub-qr-modal-dialog">
      <h3 id="hub-qr-title">QR code ‚Äì Espace √©quipe</h3>
      <img id="hub-team-qr-image" class="hub-team-qr-image" alt="QR code pour ouvrir l'Espace √©quipe"/>
      <p class="hub-qr-modal-help">Scannez ce QR code pour rouvrir rapidement l'Espace √©quipe.</p>
      <button type="button" class="hub-button hub-button-secondary" id="hub-close-team-qr">Fermer</button>
    </div>
  </div>

  <script src="<?= htmlspecialchars(cluedo_asset_url('./js/auth.js'), ENT_QUOTES, "UTF-8") ?>"></script>
  <script src="<?= htmlspecialchars(cluedo_asset_url('./js/app-version.js'), ENT_QUOTES, "UTF-8") ?>" defer></script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const auth = await window.CluedoAuth.requireAdminAccess();
      if (!auth.ok) {
        return;
      }

      const modal = document.getElementById("hub-qr-modal");
      const qrButton = document.getElementById("hub-show-team-qr");
      const closeQrButton = document.getElementById("hub-close-team-qr");
      const qrImage = document.getElementById("hub-team-qr-image");
      const teamLink = document.querySelector('.hub-button-free[href*="team.html"]');

      const buildQrImageUrl = (targetUrl) => {
        const payload = encodeURIComponent(targetUrl);
        return `https://api.qrserver.com/v1/create-qr-code/?size=320x320&format=png&data=${payload}`;
      };

      const openQrModal = () => {
        const teamHref = teamLink?.getAttribute("href") || "./team.html?test=1";
        const absoluteTargetUrl = new URL(teamHref, window.location.href).toString();
        qrImage.src = buildQrImageUrl(absoluteTargetUrl);
        modal.classList.remove("is-hidden");
      };

      const closeQrModal = () => {
        modal.classList.add("is-hidden");
      };

      qrButton?.addEventListener("click", openQrModal);
      closeQrButton?.addEventListener("click", closeQrModal);
      modal?.addEventListener("click", (event) => {
        if (event.target === modal) {
          closeQrModal();
        }
      });

      const container = document.getElementById("hub-character-list");
      const fallbackName = (id) => `Personnage ${id}`;

      const getPhotoUrl = (photoPath) => {
        if (!photoPath || !photoPath.trim()) return "";
        if (/^(https?:)?\/\//.test(photoPath) || photoPath.startsWith("data:")) return photoPath;
        return photoPath.startsWith(".") || photoPath.startsWith("/") ? photoPath : `./${photoPath}`;
      };

      let personnages = {};
      try {
        const response = await fetch("./data/personnages.json", { cache: "no-store" });
        if (response.ok) {
          personnages = await response.json();
        }
      } catch (_error) {
        // fallback conserv√©
      }

      const fragment = document.createDocumentFragment();

      const configuredIds = Object.keys(personnages)
        .filter((id) => personnages[id]?.active !== false)
        .map((id) => Number(id))
        .filter((id) => Number.isInteger(id) && id > 0)
        .sort((a, b) => a - b);
      const idsToRender = configuredIds.length ? configuredIds : Array.from({ length: 15 }, (_, index) => index + 1);

      for (const id of idsToRender) {
        const rawName = personnages[String(id)]?.nom;
        const photoPath = personnages[String(id)]?.photo;
        const name = rawName && rawName.trim() ? rawName.trim() : fallbackName(id);

        const card = document.createElement("a");
        card.className = "hub-character-card";
        card.id = `hub-character-${id}`;
        card.href = `./character.html?id=${id}`;
        card.setAttribute("aria-label", `Ouvrir la fiche de ${name}`);

        const title = document.createElement("h3");
        title.className = "hub-character-title";
        title.textContent = name;

        const characterId = document.createElement("p");
        characterId.className = "hub-character-id";
        characterId.textContent = `ID ${id}`;

        const identity = document.createElement("div");
        identity.className = "hub-character-identity";

        const photo = document.createElement("img");
        photo.className = "hub-character-photo";
        photo.alt = `Photo de ${name}`;
        photo.loading = "lazy";

        const resolvedPhotoUrl = getPhotoUrl(photoPath);
        if (resolvedPhotoUrl) {
          photo.src = resolvedPhotoUrl;
        } else {
          photo.classList.add("hub-character-photo-placeholder");
        }

        identity.append(photo, title, characterId);

        card.append(identity);
        fragment.appendChild(card);
      }

      container.innerHTML = "";
      container.appendChild(fragment);
    });
  </script>
</body>
</html>
