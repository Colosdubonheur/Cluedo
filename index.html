<?php
require_once __DIR__ . '/includes/cache.php';
cluedo_send_html_no_cache_headers();
?>
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Cluedo - Hub</title>
  <link rel="stylesheet" href="<?= htmlspecialchars(cluedo_asset_url('./css/style.css'), ENT_QUOTES, "UTF-8") ?>"/>
  <link rel="icon" href="<?= htmlspecialchars(cluedo_asset_url('./favicon.ico'), ENT_QUOTES, "UTF-8") ?>" type="image/x-icon"/>
</head>
<body>
  <div class="hub-app-version" data-app-version aria-label="Version applicative"></div>
  <div class="container">
    <h1>Hub Cluedo</h1>
    <div class="card hub-card">
      <section class="hub-section">
        <h2>Acc√®s principal</h2>
        <div class="hub-grid">
          <a class="hub-button" href="./admin.html">üîê Administration</a>
          <a class="hub-button" href="./monitor.html">üìä Supervision</a>
          <a class="hub-button" href="./team.html">üë• Espace √©quipe</a>
        </div>
      </section>

      <section class="hub-section">
        <h2>Acc√®s personnages actifs</h2>
        <div id="hub-character-list" class="hub-character-list">Chargement‚Ä¶</div>
      </section>
    </div>
  </div>

  <script src="<?= htmlspecialchars(cluedo_asset_url('./js/app-version.js'), ENT_QUOTES, "UTF-8") ?>" defer></script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const container = document.getElementById("hub-character-list");
      const fallbackName = (id) => `Personnage ${id}`;

      const getPhotoUrl = (photoPath) => {
        if (!photoPath || !photoPath.trim()) return "";
        if (/^(https?:)?\/\//.test(photoPath) || photoPath.startsWith("data:")) return photoPath;
        return photoPath.startsWith(".") || photoPath.startsWith("/") ? photoPath : `./${photoPath}`;
      };

      let personnages = {};
      try {
        const response = await fetch("./data/personnages.json", { cache: "no-store" });
        if (response.ok) {
          personnages = await response.json();
        }
      } catch (_error) {
        // fallback conserv√©
      }

      const fragment = document.createDocumentFragment();

      const configuredIds = Object.keys(personnages)
        .filter((id) => personnages[id]?.active !== false)
        .map((id) => Number(id))
        .filter((id) => Number.isInteger(id) && id > 0)
        .sort((a, b) => a - b);
      const idsToRender = configuredIds.length ? configuredIds : Array.from({ length: 15 }, (_, index) => index + 1);

      for (const id of idsToRender) {
        const rawName = personnages[String(id)]?.nom;
        const photoPath = personnages[String(id)]?.photo;
        const name = rawName && rawName.trim() ? rawName.trim() : fallbackName(id);

        const card = document.createElement("article");
        card.className = "hub-character-card";
        card.id = `hub-character-${id}`;

        const title = document.createElement("h3");
        title.className = "hub-character-title";
        title.textContent = `${id} - ${name}`;

        const identity = document.createElement("div");
        identity.className = "hub-character-identity";

        const photo = document.createElement("img");
        photo.className = "hub-character-photo";
        photo.alt = `Photo de ${name}`;
        photo.loading = "lazy";

        const resolvedPhotoUrl = getPhotoUrl(photoPath);
        if (resolvedPhotoUrl) {
          photo.src = resolvedPhotoUrl;
        } else {
          photo.classList.add("hub-character-photo-placeholder");
        }

        identity.append(photo, title);

        const actions = document.createElement("div");
        actions.className = "hub-character-actions";

        const playLink = document.createElement("a");
        playLink.className = "hub-button";
        playLink.href = `./play.html?id=${id}`;
        playLink.textContent = "Joueur";

        const characterLink = document.createElement("a");
        characterLink.className = "hub-button hub-button-secondary";
        characterLink.href = `./character.html?id=${id}`;
        characterLink.textContent = "Personnage";

        actions.append(playLink, characterLink);
        card.append(identity, actions);
        fragment.appendChild(card);
      }

      container.innerHTML = "";
      container.appendChild(fragment);
    });
  </script>
</body>
</html>
